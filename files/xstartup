#!/bin/bash
# KasmVNC xstartup - XFCE Desktop

# CRITICAL: Force XDG_RUNTIME_DIR to writable location (Singularity read-only fix)
export XDG_RUNTIME_DIR="/tmp/runtime-$(id -u)"
mkdir -p "$XDG_RUNTIME_DIR"
chmod 700 "$XDG_RUNTIME_DIR"

# Force shell to bash (Apptainer sets a weird default shell)
export SHELL=/bin/bash

# Force X11 backends (not Wayland)
export XDG_SESSION_TYPE=x11
export GDK_BACKEND=x11
export QT_QPA_PLATFORM=xcb
export MOZ_ENABLE_WAYLAND=0

# Software rendering fallback (for compatibility)
export LIBGL_ALWAYS_SOFTWARE=1

# Desktop environment variables
export XDG_CURRENT_DESKTOP=XFCE
export DESKTOP_SESSION=xfce
export XDG_CONFIG_DIRS=/etc/xdg
export XDG_DATA_DIRS=/usr/share:/usr/local/share

# Kill any stale XFCE processes
killall -q xfce4-session xfwm4 xfce4-panel xfdesktop thunar 2>/dev/null || true

# Start XFCE with dbus-run-session wrapper and apply theme settings
exec dbus-run-session -- bash -c '
# Set Adwaita-dark theme (runs after XFCE starts to ensure xfconf is available)
(
    sleep 3
    xfconf-query -c xsettings -p /Net/ThemeName -s "Adwaita-dark" 2>/dev/null || true
    xfconf-query -c xsettings -p /Net/IconThemeName -s "Adwaita" 2>/dev/null || true
    xfconf-query -c xfwm4 -p /general/theme -s "Adwaita-dark" 2>/dev/null || true

    # Set dark green solid background color (RGB: 25, 45, 30 = #192d1e)
    # Find the actual monitor name from xfconf (VNC creates dynamic names like "screen")
    MONITOR=$(xfconf-query -c xfce4-desktop -l 2>/dev/null | grep -oP "monitor[^/]+" | head -1)
    if [ -z "$MONITOR" ]; then
        MONITOR="monitorscreen"
    fi
    BACKDROP_PATH="/backdrop/screen0/${MONITOR}/workspace0"

    # Set solid color mode (color-style=0) and no image (image-style=0)
    xfconf-query -c xfce4-desktop -p "${BACKDROP_PATH}/color-style" -n -t int -s 0 2>/dev/null || true
    xfconf-query -c xfce4-desktop -p "${BACKDROP_PATH}/image-style" -n -t int -s 0 2>/dev/null || true
    # Clear any existing image path
    xfconf-query -c xfce4-desktop -p "${BACKDROP_PATH}/last-image" -r 2>/dev/null || true
    # Set the solid color (dark green)
    xfconf-query -c xfce4-desktop -p "${BACKDROP_PATH}/rgba1" -n -t double -t double -t double -t double -s 0.098039 -s 0.176471 -s 0.117647 -s 1.0 2>/dev/null || true
) &
startxfce4
'
