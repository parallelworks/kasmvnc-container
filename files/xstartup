#!/bin/bash
# KasmVNC xstartup - XFCE Desktop

# CRITICAL: Force XDG_RUNTIME_DIR to writable location (Singularity read-only fix)
export XDG_RUNTIME_DIR="/tmp/runtime-$(id -u)"
mkdir -p "$XDG_RUNTIME_DIR"
chmod 700 "$XDG_RUNTIME_DIR"

# Force shell to bash (Apptainer sets a weird default shell)
export SHELL=/bin/bash

# Force X11 backends (not Wayland)
export XDG_SESSION_TYPE=x11
export GDK_BACKEND=x11
export QT_QPA_PLATFORM=xcb
export MOZ_ENABLE_WAYLAND=0

# Software rendering fallback (for compatibility)
export LIBGL_ALWAYS_SOFTWARE=1

# Desktop environment variables
export XDG_CURRENT_DESKTOP=XFCE
export DESKTOP_SESSION=xfce
export XDG_CONFIG_DIRS=/etc/xdg
export XDG_DATA_DIRS=/usr/share:/usr/local/share

# Kill any stale XFCE processes
killall -q xfce4-session xfwm4 xfce4-panel xfdesktop thunar 2>/dev/null || true

# Start XFCE with dbus-run-session wrapper and apply theme settings
exec dbus-run-session -- bash -c '
# Set Adwaita-dark theme (runs after XFCE starts to ensure xfconf is available)
(
    sleep 2
    xfconf-query -c xsettings -p /Net/ThemeName -s "Adwaita-dark" 2>/dev/null || true
    xfconf-query -c xsettings -p /Net/IconThemeName -s "Adwaita" 2>/dev/null || true
    xfconf-query -c xfwm4 -p /general/theme -s "Adwaita-dark" 2>/dev/null || true
    # Set dark teal background color (RGB: 27, 42, 53 = #1b2a35)
    xfconf-query -c xfce4-desktop -p /backdrop/screen0/monitorscreen/workspace0/color-style -n -t int -s 0 2>/dev/null || true
    xfconf-query -c xfce4-desktop -p /backdrop/screen0/monitorscreen/workspace0/image-style -n -t int -s 0 2>/dev/null || true
    xfconf-query -c xfce4-desktop -p /backdrop/screen0/monitorscreen/workspace0/rgba1 -n -t double -t double -t double -t double -s 0.105882 -s 0.164706 -s 0.207843 -s 1.0 2>/dev/null || true
) &
startxfce4
'
